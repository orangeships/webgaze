# 实现手眼协同交互系统的手部控制功能（更新版）

## 1. 系统架构分析

现有系统主要由`EyeHandInteractionSystem`类实现，包含初始化、校准、交互模式等核心功能。为了实现手部控制功能，需要集成手部检测系统，并确保并行处理机制稳定可靠。同时，需要移除现有的基于距离的跳转机制，避免与新的手部控制功能发生干扰。

## 2. 实现计划

### 2.1 集成手部检测系统

- **在`EyeHandInteractionSystem`类中添加手部检测相关成员变量**
  - 手部检测系统实例
  - 手控模式状态变量
  - 鼠标控制相关变量
  - 视觉反馈相关变量
  - 连续未检测到捏合动作的帧数计数器

- **创建手部检测线程类**
  - 继承`QThread`，实现后台手部检测
  - 定义信号用于传递检测结果
  - 实现手部检测的主要逻辑

- **在系统初始化时启动手部检测线程**
  - 在`initialize`方法中创建并启动手部检测线程
  - 确保手部检测在后台运行，不阻塞主线程

### 2.2 移除现有基于距离的跳转机制

- **修改`_process_hand_eye_coordination`方法**
  - 移除基于滑动窗口的距离阈值检测
  - 简化方法，仅保留必要的注视点处理逻辑

- **修改`_check_distance_threshold_and_move_cursor`方法**
  - 移除该方法，不再使用基于距离的鼠标跳转

- **修改`_auto_move_mouse_to_gaze`方法**
  - 移除基于距离的鼠标自动移动逻辑
  - 保留方法结构，用于后续手部控制功能

### 2.3 实现捏合动作检测

- **添加捏合动作处理方法**
  - 实现`on_pinch_detected`方法处理捏合动作
  - 当检测到捏合动作时，进入手控模式

- **实现鼠标移动和视觉反馈**
  - 将鼠标移动到当前注视点
  - 实现`show_green_selection_box`方法显示绿色待选框
  - 暂停注视追踪功能

### 2.4 实现拇指控制鼠标移动

- **追踪大拇指位置**
  - 实现`on_thumb_position_updated`方法处理大拇指位置更新
  - 计算大拇指移动距离和方向

- **控制鼠标移动**
  - 根据大拇指移动距离控制鼠标移动
  - 实现平滑的鼠标控制算法

### 2.5 实现手控模式退出机制

- **监测捏合动作状态**
  - 实现`on_no_pinch_detected`方法处理未检测到捏合动作的情况
  - 记录连续未检测到捏合动作的帧数

- **退出手控模式**
  - 当连续5帧未检测到捏合动作时，调用`exit_hand_control_mode`方法
  - 恢复注视追踪功能
  - 隐藏绿色待选框

### 2.6 优化并行处理机制

- **确保线程安全**
  - 使用信号槽机制传递检测结果
  - 避免线程间直接共享数据

- **控制响应延迟**
  - 优化手部检测算法，确保实时性
  - 调整手部检测和眼部追踪的帧率

## 3. 关键实现细节

### 3.1 手部检测线程

```python
class HandDetectionThread(QThread):
    pinch_detected = pyqtSignal(tuple)
    thumb_position = pyqtSignal(tuple)
    no_pinch_detected = pyqtSignal()
    
    def run(self):
        # 初始化手部检测系统
        # 手部检测主循环
        # 检测到捏合动作时，发送pinch_detected信号
        # 检测到大拇指位置时，发送thumb_position信号
        # 未检测到捏合动作时，发送no_pinch_detected信号
        pass
```

### 3.2 手控模式状态管理

```python
def on_pinch_detected(self, pinch_position):
    # 进入手控模式
    self.hand_control_mode = True
    self.no_pinch_frame_count = 0
    # 移动鼠标到注视点
    # 显示绿色待选框
    # 暂停注视追踪
    
def on_thumb_position_updated(self, thumb_position):
    if self.hand_control_mode:
        # 计算大拇指移动距离
        # 控制鼠标移动
        pass
    
def on_no_pinch_detected(self):
    if self.hand_control_mode:
        self.no_pinch_frame_count += 1
        if self.no_pinch_frame_count >= 5:
            self.exit_hand_control_mode()
    
def exit_hand_control_mode(self):
    # 退出手控模式
    self.hand_control_mode = False
    self.no_pinch_frame_count = 0
    # 恢复注视追踪
    # 隐藏绿色待选框
```

### 3.3 视觉反馈实现

```python
def show_green_selection_box(self, position):
    # 创建并显示绿色待选框
    # 使用InteractionOverlay类实现
    pass
    
def hide_green_selection_box(self):
    # 隐藏并销毁绿色待选框
    pass
```

## 4. 测试和优化

- **测试手部检测的准确性和实时性**
- **优化鼠标控制的平滑度和响应速度**
- **测试手控模式切换的稳定性**
- **优化系统整体性能，确保流畅运行**

## 5. 预期效果

- 系统能够在后台并行运行手部检测
- 检测到捏合动作时，鼠标自动移动到注视点并显示绿色待选框
- 手控模式下，能够通过大拇指移动控制鼠标
- 连续5帧未检测到捏合动作时，自动退出手控模式
- 系统整体运行流畅，响应延迟在可接受范围内
- 移除了基于距离的跳转机制，避免与手部控制功能发生干扰